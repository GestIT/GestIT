<!doctype html>
<html>
<head>
<script src="http://api.maps.nokia.com/2.2.4/jsl.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="http://gestit.github.io/GestIT/JavaScript/lib/GestIT.js"></script>
<script type="text/javascript" src="http://gestit.github.io/GestIT/JavaScript/lib/GestITouch.js"></script>
<script type="text/javascript">
function Matrix(a, b, c, d, e, f) {
  this.a = a ? a : 1; // (1, 1)
  this.b = b ? b : 0; // (2, 1)
  this.c = c ? c : 0; // (1, 2)
  this.d = d ? d : 1; // (2, 2)
  this.e = e ? e : 0; // (1, 3)
  this.f = f ? f : 0; // (2, 3)
  // Last row is 0 0 1

  this.mul = function (m) {
    return    new Matrix(this.a * m.a + this.c * m.b,
                          this.b * m.a + this.d * m.b,
                          this.a * m.c + this.c * m.d,
                          this.b * m.c + this.d * m.d,
                          this.a * m.e + this.c * m.f + this.e,
                          this.b * m.e + this.d * m.f + this.f);
  };
  
  this.transform = function (ctx) { ctx.setTransform(this.a, this.b, this.c, this.d, this.e, this.f); };
  this.transformPoint = function (x, y) { 
    return { 'x': this.a * x + this.c * y + this.e, 'y': this.b * x + this.d * y + this.f }; }; 
}

var identity = new Matrix();

function createTranslateMatrix(tx, ty) { return new Matrix(1, 0, 0, 1, tx, ty); }
function createScaleMatrix(sx, sy) { return new Matrix(sx, 0, 0, sy, 0, 0); }
function createRotateMatrix(alpha) { return new Matrix(Math.cos(alpha), Math.sin(alpha), -Math.sin(alpha), Math.cos(alpha), 0, 0); }

function WorldTransform() {
  this.w2v = new Matrix();
  this.v2w = new Matrix();
  this.stack = new Array();

  this.push = function () {
    this.stack.push(this.w2v);
    this.stack.push(this.v2w);
  };
  
  this.pop = function (discard) {
    if (!this.stack.length) return;
    var v2w = this.stack.pop();
    var w2v = this.stack.pop();
    if (!discard) {
      this.v2w = v2w; this.w2v = w2v;
    }
  };

  this. reset = function() {
    this.w2v = new Matrix();
    this.v2w = new Matrix();
  };

  this.transform = function (m, im) {
    this.w2v = m.mul(this.w2v);
    this.v2w = this.v2w.mul(im);
  };
  
  this.rotate = function (alpha) { this.transform(createRotateMatrix(alpha), createRotateMatrix(-alpha)); };
  this.rotateAt = function (x, y, alpha) { 
    this.translate(-x, -y);
    this.rotate(alpha);
    this.translate(x, y);
  };
  this.translate = function (tx, ty) { this.transform(createTranslateMatrix(tx, ty), createTranslateMatrix(-tx, -ty)); };
  this.scale = function (sx, sy) { this.transform(createScaleMatrix(sx, sy), createScaleMatrix(1/sx, 1/sy)); };
}
</script>

<script type="text/javascript">
nokia.Settings.set("appId", "luZTELUcbIMUf5D6Nj6a"); 
nokia.Settings.set("authenticationToken", "DR--NGFudd2HSGSciT-kRg");
var map = null;
function init() {
  prova();
  map = new nokia.maps.map.Display(
      document.getElementById("mapContainer"), {
          'components': [
            new nokia.maps.map.component.ZoomBar(),
            new nokia.maps.map.component.Overview(),
            new nokia.maps.map.component.TypeSelector(),
            new nokia.maps.map.component.ScaleBar()
          ],
          // Zoom level for the map
          'zoomLevel': 10,
          // Map center coordinates
          'center': [52.51, 13.4] 
      });
      
      map.fading = 100;
}

function computeZoom(z) {
  var cz = map.zoomLevel;
  return cz + (cz / 20) * (z > 1 ? z : - (1/z));
}

function prova() {
  var mc = document.getElementById('mapContainer');
  var ts = listenTouch(mc, true, true);
  var mag = null;
  var lastz = 1;
  var mid = null;
  var lastmid = null;
  var W = null;
  
  pinchAndZoom(
    function (e) {
      
      if (mag == null) { 
        mag = e.magnitude();
        mid = { 'x': (e.p1.x + e.p2.x) / 2, 'y': (e.p1.y + e.p2.y) / 2 };
        return; }
      var m = e.magnitude();
      lastz =  (m/mag);
      var dd = mc.childNodes[1];
      dd.style.transformOrigin = mid.x + 'px ' + mid.y + 'px';
      dd.style.transform = 'scale(' + lastz + ')';
    },
    function (e) { 
      mc.childNodes[1].style.transform = ''; 
      mc.childNodes[1].style.left = '0'; 
      mc.childNodes[1].style.top = '0'; 
      mag = null; 

      var p = map.pixelToGeo(mid.x, mid.y);
      map.setZoomLevel(computeZoom(lastz)); 
      p = map.geoToPixel(p);
      map.pan(0, 0, p.x - mid.x, p.y - mid.y);
      map.update(10); 
    },
    ts);
}
</script>
<style>
#mapContainer div {
  -ms-touch-action: none;
}
</style>
</head>
<body onload="init();">
<div id="mapContainer" style="width: 1800px; height: 900px; -ms-touch-action: none; overflow: hidden;">
</div>
</body>
</html>
