<!doctype html>
<html>
<head>
<script src="http://api.maps.nokia.com/2.2.4/jsl.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="http://gestit.github.io/GestIT/JavaScript/lib/GestIT.js"></script>
<script type="text/javascript" src="http://gestit.github.io/GestIT/JavaScript/lib/GestITouch.js"></script>

<script type="text/javascript">
nokia.Settings.set("appId", "luZTELUcbIMUf5D6Nj6a"); 
nokia.Settings.set("authenticationToken", "DR--NGFudd2HSGSciT-kRg");
var map = null;
function init() {
  prova();
  map = new nokia.maps.map.Display(
      document.getElementById("mapContainer"), {
          'components': [
            new nokia.maps.map.component.ZoomBar(),
            new nokia.maps.map.component.Overview(),
            new nokia.maps.map.component.TypeSelector(),
            new nokia.maps.map.component.ScaleBar()
          ],
          // Zoom level for the map
          'zoomLevel': 10,
          // Map center coordinates
          'center': [52.51, 13.4] 
      });
      
      map.fading = 100;
}

function computeZoom(z) {
  var cz = map.zoomLevel;
  return cz + (cz / 20) * (z > 1 ? z : - (1/z));
}

function isdefined(v) {
  return !(v === undefined);
}
function transform(d, ox, oy, t) {
  var p = 'transform';
  if (!isdefined(d.style.transform) && isdefined(d.style.webkitTransform)) p = 'webkitTransform';
  if (!isdefined(d.style.transform) && isdefined(d.style.msTransform)) p = 'msTransform';
  d.style[p + 'Origin'] = ox + 'px ' + oy + 'px';
  d.style[p] = t;
}

function prova() {
  var mc = document.getElementById('mapContainer');
  var ts = listenTouch(mc, true, true);
  var mag = null;
  var lastz = 1;
  var mid = null;
  var lastmid = null;
  var W = null;
  
  pinchAndZoom(
    function (e) {
      
      if (mag == null) { 
        mag = e.magnitude();
        mid = { 'x': (e.p1.x + e.p2.x) / 2, 'y': (e.p1.y + e.p2.y) / 2 };
        return; }
      var m = e.magnitude();
      lastz =  (m/mag);
      transform(mc.childNodes[1], mid.x, mid.y, 'scale(' + lastz + ')');
    },
    function (e) { 
      transform(mc.childNodes[1], mid.x, mid.y, '');
      mag = null; 

      var p = map.pixelToGeo(mid.x, mid.y);
      map.setZoomLevel(computeZoom(lastz)); 
      p = map.geoToPixel(p);
      map.pan(0, 0, p.x - mid.x, p.y - mid.y);
      map.update(10); 
    },
    ts);
}
</script>
<style>
#mapContainer div {
  -ms-touch-action: none;
}
</style>
</head>
<body onload="init();">
<div id="mapContainer" style="width: 1800px; height: 900px; -ms-touch-action: none; overflow: hidden;">
</div>
</body>
</html>
