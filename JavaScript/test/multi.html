<!doctype html>
<html>
<head>
<script type="text/javascript" src="../lib/GestIT.js"></script>
<script type="text/javascript">
function print(s) {
  var console = document.getElementById('console');
  console.innerHTML += s + '<br/>';
  console.scrollTop = console.scrollHeight;
}

function TouchEvent() {
  this.altKey = false;
  this.ctrlKey = false;
  this.metaKey = false;
  this.shiftKey = false;
  this.type = '';
  this.identifier = 0;
  this.screenX = 0;
  this.screenY = 0;
  this.clientX = 0;
  this.clientY = 0;
  this.pageX = 0;
  this.pageY = 0;
  this.target = null;
  this.radiusX = 0;
  this.radiusY = 0;
  this.rotationAngle = 0;
  this.force = 0;
  
  var copyMods = function (event) {
    this.altKey = event.altKey;
    this.ctrlKey = event.ctrltKey;
    this.metaKey = event.metaKey;
    this.shiftKey = event.shiftKey;
    this.type = event.type;
  }
  
  var copyCommon = function (event) {
    this.screenX = event.screenX;
    this.screenY = event.screenY;
    this.clientX = event.clientX;
    this.clientY = event.clientY;
    this.pageX = event.pageX;
    this.pageY = event.pageY;
    this.target = event.target;
  }
  
  this.copyFromMSPointer = function (event) {
    copyMods(event);
    copyCommon(event);
    this.identifier = event.pointerId;
    this.radiusX = event.width;
    this.radiusY = event.height;
    this.rotationAngle = event.rotation;
    this.force = event.pressure;
  };
  
  this.copyFromTouch = function (parentevent, touchevent) {
    copyMods(parentevent);
    copyCommon(touchevent);
    this.identifier = touchevent.identifier;
    this.radiusX = touchevent.radiusX;
    this.radiusY = touchevent.radiusY;
    this.rotationAngle = touchevent.rotationAngle;
    this.force = touchevent.force;
  };
}

var TouchFeature = {
  TouchDown: 0,
  TouchMove: 1,
  TouchUp: 2
}

function listenTouch(element) {
  var d = typeof(element) == 'string' ? document.getElementById(element) : element;
  var ret = new FusionSensor();
  if (navigator.msMaxTouchPoints) {
    d.style.msTouchAction = 'none';
    var MShandler = function (e) { 
      var ret = e.pointerType == 'touch' ? new TouchEvent() : null; 
      if (ret) {
        e.preventDefault();
        ret.copyFromMSPointer(e);
        return [ ret ];
      }
      return [];
    };
    ret.listen(d, TouchFeature.TouchDown, 'MSPointerDown', MShandler);
    ret.listen(d, TouchFeature.TouchMove, 'MSPointerMove', MShandler);
    ret.listen(d, TouchFeature.TouchUp, 'MSPointerUp', MShandler);
    d.addEventListener('MSHoldVisual', function (event) {
        event.preventDefault();
    });
  } else {
    var THandler = function (e) { 
      var ret = []; 
      e.preventDefault();
      for (var i = 0; i < e.touches.length; i++) {
        var t = new TouchEvent();
        t.copyFromTouch(e, e.touches[i]);
        ret.push(t);
      }
      return ret;
    };
    ret.listen(d, TouchFeature.TouchDown, 'touchstart', THandler);
    ret.listen(d, TouchFeature.TouchMove, 'touchmove', THandler);
    ret.listen(d, TouchFeature.TouchUp, 'touchend', THandler);
  }
  d.addEventListener('contextmenu', function (event) {
        event.preventDefault();
  });
  d.addEventListener('selectstart', function (event) {
        event.preventDefault();
  });
  return ret;
}


function init() {
  var ts = listenTouch('canvas');
  var td = new GroundTerm(TouchFeature.TouchDown, function () { return true; });
  var tm = new GroundTerm(TouchFeature.TouchMove, function () { return true; });
  var tu = new GroundTerm(TouchFeature.TouchUp, function () { return true; });
  
  td.gesture.add(function (e) { print('Touch #' + e.evt.identifier + ' down!'); });
  tm.gesture.add(function (e) { print('Touch #' + e.evt.identifier + ' move!'); });
  tu.gesture.add(function (e) { print('Touch #' + e.evt.identifier + ' up!'); });
  gesture = new Choice([new Sequence([td, new Iter(tm)]), tu]);
  net = gesture.toGestureNet(ts);

}

</script>
</head>
<body onload="init()">
<div id="canvas" style="height: 500px; background: yellow"></div>
<div id="console" style="height: 500px; background: black; color: white; overflow: auto"></div>

</body>
</html>
